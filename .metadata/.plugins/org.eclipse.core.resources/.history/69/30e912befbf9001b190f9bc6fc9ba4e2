package webcontent.service;

import com.liferay.journal.model.JournalArticle;
import com.liferay.journal.model.JournalFolder;
import com.liferay.journal.service.JournalFolderServiceUtil;
import com.liferay.portal.kernel.json.JSONFactoryUtil;
import com.liferay.portal.kernel.json.JSONObject;
import com.liferay.portal.kernel.xml.Document;
import com.liferay.portal.kernel.xml.DocumentException;
import com.liferay.portal.kernel.xml.Node;
import com.liferay.portal.kernel.xml.SAXReaderUtil;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.osgi.service.component.annotations.Component;

/**
 * @author nimisha
 */
@Component(
	immediate = true,
	property = {
		// TODO enter required service properties
	},
	service = WebcontentService.class
)
public class WebcontentService  {

	public List<JournalFolder> getJournalFoldersFromObject(List<Object> jfList) {

		List<JournalFolder> journalFolders=jfList.stream().filter(a->
		a.getClass().getName().contains("JournalFolder")
	).map(x->((JournalFolder)x)).collect(Collectors.toList());
		
		
		return journalFolders;
		
	}
	
	
	public List<JournalArticle> getJournalArticleFromObject(List<Object> jfList){
		List<JournalArticle> journalArticles=jfList.stream().filter(a->
		a.getClass().getName().contains("JournalArticle")
	).map(x->((JournalArticle)x)).filter(x->x.getDDMStructureKey().equals("38121")).collect(Collectors.toList());
		journalArticles.forEach(ja->{
			JSONObject article = JSONFactoryUtil.createJSONObject();
			article.put("ArticleId", ja.getArticleId());
			try {
				article.put("ArticleName", getStringFields(ja.getContent(), "Title"));
			} catch (DocumentException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			try {
				article.put("ArticleContent", getStringFields(ja.getContent(), "Content"));
			} catch (DocumentException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		});
		
		return journalArticles;
	}
	
	public Map<JournalFolder,List<Object>> getMenuListing(long groupId, JournalFolder journalFolder, Map<JournalFolder,List<Object>> listing){
		int jfCount=JournalFolderServiceUtil.getFoldersAndArticlesCount(groupId, journalFolder.getFolderId(), 0);
		List<Object> jfList=JournalFolderServiceUtil.getFoldersAndArticles(groupId, journalFolder.getFolderId(), 0,0, jfCount, null);
		if(jfList!=null) {
			List<Object> child= new ArrayList<>();
			List<JournalArticle> journalArticles=getJournalArticleFromObject(jfList);
			child.addAll(journalArticles);
			List<JournalFolder> journalFolders=getJournalFoldersFromObject(jfList);
			child.addAll(journalFolders);
			listing.put(journalFolder, child);
			journalFolders.forEach(folder->{
				getMenuListing(groupId, folder,listing);
			});
		}
		Object json = JSONFactoryUtil.createJSONObject();
		

		return listing;
		
	}
	
	
	public JSONObject getMenuListingg(long groupId, JournalFolder journalFolder, Map<JournalFolder,List<Object>> listing){
		int jfCount=JournalFolderServiceUtil.getFoldersAndArticlesCount(groupId, journalFolder.getFolderId(), 0);
		List<Object> jfList=JournalFolderServiceUtil.getFoldersAndArticles(groupId, journalFolder.getFolderId(), 0,0, jfCount, null);
		if(jfList!=null) {
			List<Object> child= new ArrayList<>();
			List<JournalArticle> journalArticles=getJournalArticleFromObject(jfList);
			journalArticles.forEach(ja->{
				JSONObject article = JSONFactoryUtil.createJSONObject();
				article.put("ArticleId", ja.getArticleId());
				article.put("ArticleName", getStringFields(ja.getContent(), "Title"));
				article.put("ArticleContent", getStringFields(ja.getContent(), "Content"));
			});
			child.addAll(journalArticles);
			List<JournalFolder> journalFolders=getJournalFoldersFromObject(jfList);
			child.addAll(journalFolders);
			listing.put(journalFolder, child);
			JSONObject listing = JSONFactoryUtil.createJSONObject();
			listing.put("FolderName", journalFolder.getName());
			listing.put("FolderId", journalFolder.getFolderId());
			listing.put("Folder Description", journalFolder.getDescription());
			listing.put("ArticleList", journalArticles);
			listing.put("SubFolders", value);
			
			
			
			
			journalFolders.forEach(folder->{
				getMenuListing(groupId, folder,listing);
			});
		}
		
		

		return listing;
		
	}
	
	public String getStringFields(String content, String fieldName) {
		Document doc;
		try {
			doc = SAXReaderUtil.read(content);
		
		Node node = doc.selectSingleNode("/root/dynamic-element[@name='"+fieldName+"']/dynamic-content");
		} catch (DocumentException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		//int number= Integer.parseInt(node.getText());
		return node.getText();
	}

}